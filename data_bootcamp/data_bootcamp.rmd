---
title: "in_class_week_01"
author: "Sean Mussenden"
date: "8/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries and settings

```{r}
library(tidyverse)
library(lubridate)
library(janitor)
library(tidycensus)
library(googlesheets4)
library(gargle)

# Define API Key
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

# Define google sheets keys
intro_to_data_journalism_1 <- "10B1-iMyBZkB5EjMRFlbgrxcaBnxVJMkHOo8WK3Og66Y"
intro_to_data_journalism_2 <- "1MnVkk3E2SKDj-s37ctlV7SVKcXQKP_DcvxJ9QuXbXi8"
```

## Authorize Google Sheets 4 in the console
```{r}
## Setup for googlesheets authentication
# In the console, type:
 token_fetch()
# It will authenticate with browser
# Then in the console type
gs4_auth(
 email = gargle::gargle_oauth_email(),
 path = NULL,
 scopes = "https://www.googleapis.com/auth/spreadsheets",
 cache = gargle::gargle_oauth_cache(),
 use_oob = gargle::gargle_oob_default(),
 token = NULL
)
# It will authenticate in browser
# Run this in md to confirm it worked, should give my email address
gs4_user()


```

## Load Data

```{r}
### Read in current data from the New York Times county-by-county COVID tracking from GitHub
# Read in county historical data on Aug 31
#covid_county <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv")
#write_csv(covid_county, "covid_county_current_08_31_2020.csv") 
# Read in state historical data on Aug 31
#covid_state <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv")
#write_csv(covid_state, "covid_state_current_08_31_2020.csv") 
# Read in US historical data on Aug 31
#covid_us <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us.csv")
#write_csv(covid_us, "covid_us_current_08_31_2020.csv") 

### Read in stored data pulled from NYT Github on Aug 31
covid_county <- read_csv("covid_county_current_08_31_2020.csv") %>%
  filter(!state %in% c("Northern Mariana Islands","Puerto Rico","Virgin Islands", "Guam")) %>%
  filter(!county %in% c("Unknown")) %>%
  select(fips_code = fips, county, state, date, cases, deaths)

covid_state <- read_csv("covid_state_current_08_31_2020.csv") %>%
  filter(!state %in% c("Northern Mariana Islands","Puerto Rico","Virgin Islands", "Guam"))  %>%
  select(fips_code = fips, state, date, cases, deaths)
  
covid_us <- read_csv("covid_us_current_08_31_2020.csv") %>%
  mutate(location="US") %>%
  select(location, everything())

### Read in population data from census
population_county <- get_acs(geography="county", variables=c("B01001_001"),geometry = FALSE, year=2018) %>%
  clean_names() %>%
  select(fips_code=geoid,
         population=estimate) 

population_state<- get_acs(geography="state", variables=c("B01001_001"),geometry = FALSE, year=2018) %>%
  clean_names() %>%
  select(fips_code=geoid,
         population=estimate) 

population_us <- get_acs(geography="us", variables=c("B01001_001"),geometry = FALSE, year=2018) %>%
  clean_names() %>%
  select(fips_code=geoid,
         population=estimate) 

###Join population data to covid data
covid_county <- covid_county %>%
  left_join(population_county, by=c("fips_code")) %>%
  mutate(population = case_when(county == "New York City" ~ 8398748,
                                county == "Kansas City" ~ 491918,
                                county == "Joplin" ~ 50657,
                                TRUE~population)) %>%
  select(-fips_code) 

covid_state <- covid_state %>%
  left_join(population_state, by=c("fips_code")) %>%
  rename(location = state) %>%
  select(-fips_code) 

covid_us <- covid_us %>%
  mutate(fips_code = "1") %>%
  left_join(population_us, by=c("fips_code")) %>%
  select(-fips_code) 

rm(population_county, population_state, population_us)

# Join state and us data

covid_state_us <- covid_state %>%
  bind_rows(covid_us)

rm(covid_state, covid_us)

### Dataframe of current cases 
covid_county_current <- covid_county %>%
  filter(date == "2020-08-30") 

covid_state_us_current <- covid_state_us %>%
  filter(date == "2020-08-30")

### Dataframe of cumulative monthly cases per capita as of 30th day of each month

covid_county_monthly_case_rate <- covid_county %>%
  filter(str_detect(date,"2020-03-30|2020-04-30|2020-05-30|2020-06-30|2020-07-30|2020-08-30")) %>%
  mutate(date = paste0("d-",date)) %>%
  mutate(cases_per_100k = cases/population*100000) %>%
  select(county:date, cases_per_100k) %>%
  pivot_wider(names_from = date, values_from = cases_per_100k) %>%
  mutate_if(is.numeric , replace_na, replace = 0)

### Dataframe of cumulative monthly deaths per capita as of 30th day of each month
covid_county_monthly_death_rate <- covid_county %>%
  filter(str_detect(date,"2020-03-30|2020-04-30|2020-05-30|2020-06-30|2020-07-30|2020-08-30")) %>%
  mutate(date = paste0("d-",date)) %>%
  mutate(deaths_per_100k = deaths/population*100000) %>%
  select(county:date, deaths_per_100k) %>%
  pivot_wider(names_from = date, values_from = deaths_per_100k) %>%
  mutate_if(is.numeric , replace_na, replace = 0)

# Write sheets
sheet_write(covid_county_current, ss = intro_to_data_journalism_1 , sheet = "covid_county_current")
sheet_write(covid_state_us_current, ss = intro_to_data_journalism_1 , sheet = "covid_state_us_current")
sheet_write(covid_county_monthly_case_rate, ss = intro_to_data_journalism_1 , sheet = "covid_county_monthly_case_rate")
sheet_write(covid_county_monthly_death_rate, ss = intro_to_data_journalism_1 , sheet = "covid_county_monthly_death_rate")





```

### Dataframe of cumulitive totals on 30th day of each month

# Join population and covid stats together to create county current sheet
covid_county_current <- covid_county_current %>%
  left_join(population_county, by=c("fips_code")) %>%
  filter(county != "Unknown") %>%
  mutate(population = case_when(county == "New York City" ~ 8398748,
                                county == "Kansas City" ~ 491918,
                                county == "Joplin" ~ 50657,
                                TRUE~population)) %>%
  filter(!state %in% c("Northern Mariana Islands","Puerto Rico","Virgin Islands"))


# Join population and covid stats together to 
covid_state_current <- covid_county_current %>%
  group_by(state) %>%
  summarise(cases = sum(cases),
            deaths = sum(deaths),
            population = sum(population))

nyt_covid_county_historical <- nyt_covid_county_historical %>%
  dplyr::select(fips_code = fips, county, state, date, cases, deaths) %>%
  mutate(month = month(date)) %>%
  group_by(fips_code, county, state, month) %>%
  summarise(cases = sum(cases)) %>%
  filter(month %in% c(3,4,5,6,7,8)) %>%
  mutate(month = paste0("month_",month,"_cum_cases_per_100k")) %>%
  left_join(population_county, by=c("fips_code")) %>%
  mutate(cases_per_100k = cases/population*100000) %>%
  dplyr::select(fips_code:month, cases_per_100k) %>%
  pivot_wider(names_from = month, values_from = cases_per_100k) %>%
  mutate_if(is.numeric , replace_na, replace = 0) %>%
  ungroup() %>%
  mutate(month_3_rank_per_100k = dplyr::ntile(month_3_cum_cases_per_100k, 100),
         month_4_rank_per_100k = dplyr::ntile(month_4_cum_cases_per_100k, 100),
         month_5_rank_per_100k = dplyr::ntile(month_5_cum_cases_per_100k, 100),
         month_6_rank_per_100k = dplyr::ntile(month_6_cum_cases_per_100k, 100),
         month_7_rank_per_100k = dplyr::ntile(month_7_cum_cases_per_100k, 100),
         month_8_rank_per_100k = dplyr::ntile(month_8_cum_cases_per_100k, 100)
         ) %>%
  dplyr::select(fips_code: state, month_3_rank_per_100k:month_8_rank_per_100k, month_3_cum_cases_per_100k:month_8_cum_cases_per_100k)


# Write sheets
sheet_write(covid_county_current, ss = intro_to_data_journalism_1 , sheet = "covid_county_current")
sheet_write(covid_state_current, ss = intro_to_data_journalism_1 , sheet = "covid_state_current")


```

# Load NYT all historical 
nyt_covid_county_historical <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv") 

# Rearrange columns
nyt_covid_county_historical <- nyt_covid_county_historical %>%
  dplyr::select(fips_code = fips, county, state, date, cases, deaths) %>%
  mutate(month = month(date)) %>%
  group_by(fips_code, county, state, month) %>%
  summarise(cases = sum(cases)) %>%
  filter(month %in% c(3,4,5,6,7,8)) %>%
  mutate(month = paste0("month_",month,"_cum_cases_per_100k")) %>%
  inner_join(population_county, by=c("fips_code")) %>%
  mutate(cases_per_100k = cases/population*100000) %>%
  dplyr::select(fips_code:month, cases_per_100k) %>%
  pivot_wider(names_from = month, values_from = cases_per_100k) %>%
  mutate_if(is.numeric , replace_na, replace = 0) %>%
  ungroup() %>%
  mutate(month_3_rank_per_100k = dplyr::ntile(month_3_cum_cases_per_100k, 100),
         month_4_rank_per_100k = dplyr::ntile(month_4_cum_cases_per_100k, 100),
         month_5_rank_per_100k = dplyr::ntile(month_5_cum_cases_per_100k, 100),
         month_6_rank_per_100k = dplyr::ntile(month_6_cum_cases_per_100k, 100),
         month_7_rank_per_100k = dplyr::ntile(month_7_cum_cases_per_100k, 100),
         month_8_rank_per_100k = dplyr::ntile(month_8_cum_cases_per_100k, 100)
         ) %>%
  dplyr::select(fips_code: state, month_3_rank_per_100k:month_8_rank_per_100k, month_3_cum_cases_per_100k:month_8_cum_cases_per_100k)

```

# Analysis

Q: As of August 30, what state had the highest average death rate (deaths per 100K)

```{r}
covid_county_population %>%
  group_by(state) %>%
  summarise(deaths = sum(deaths),
            population = sum(population)) %>%
  mutate(deaths_per_100k = deaths/population*100000) %>%
  dplyr::select(state, deaths_per_100k) %>%
  arrange(desc(deaths_per_100k))
  
```

Q: As of August 30, what state had the highest average case rate (cases per 100K)

```{r}
covid_county_population %>%
  group_by(state) %>%
  summarise(cases = sum(cases),
            population = sum(population)) %>%
  mutate(cases_per_100k = cases/population*100000) %>%
  dplyr::select(state, cases_per_100k) %>%
  arrange(desc(cases_per_100k))
  
```

Q: As of August 30, what county had the highest death rate (deaths per 100K people)
```{r}

covid_county_population %>%
  arrange(desc(deaths_per_100k))

```
Q: As of August 30, what county had the highest case rate (cases per 100K people)

```{r}

covid_county_population %>%
  arrange(desc(cases_per_100k))

```

Q: Are there any trends we can detect geographically with cases?

```{r}
# Join county shapes to other shapes
covid_county_population_geo <- geo_join(counties, covid_county_population, 'GEOID', 'fips_code', how = "inner")  

# Define Color Scheme
binpal <- colorBin("plasma", covid_county_population_geo$cases_per_100k, 10, pretty = FALSE)

# Draw map

leaflet(covid_county_population_geo) %>%
   addProviderTiles(providers$CartoDB.Positron) %>%
   #addProviderTiles(providers$Wikimedia) %>%
   addPolygons(fillColor = ~binpal(cases_per_100k), weight = 1, smoothFactor = 0.5, opacity = 0.1, fillOpacity = 0.5, color="black", popup = popupTable(covid_county_population_geo)) %>%
   setView(-95, 39.335359608681216, 4) %>%
    addLegend("bottomleft", 
             pal = binpal, 
             values = covid_county_population_geo$cases_per_100k,
    title = "Cases per 100K",
    labFormat = labelFormat(prefix = ""),
    opacity = 1
  ) 
```
Q: Are there any trends we can detect geographically with deaths?

```{r}
# Join county shapes to other shapes
covid_county_population_geo <- geo_join(counties, covid_county_population, 'GEOID', 'fips_code', how = "inner")  

# Define Color Scheme
binpal <- colorBin("plasma", covid_county_population_geo$deaths_per_100k, 10, pretty = FALSE)

# Draw map

leaflet(covid_county_population_geo) %>%
   addProviderTiles(providers$CartoDB.Positron) %>%
   #addProviderTiles(providers$Wikimedia) %>%
   addPolygons(fillColor = ~binpal(deaths_per_100k), weight = 1, smoothFactor = 0.5, opacity = 0.1, fillOpacity = 0.5, color="black", popup = popupTable(covid_county_population_geo)) %>%
   setView(-95, 39.335359608681216, 4) %>%
    addLegend("bottomleft", 
             pal = binpal, 
             values = covid_county_population_geo$deaths_per_100k,
    title = "Deaths per 100K",
    labFormat = labelFormat(prefix = ""),
    opacity = 1
  ) 
```
# 


# Compute national covid averages
covid_us <- covid_county %>%
  filter(!is.na(deaths)) %>%
  summarise(cases=sum(cases),
            deaths=sum(deaths)) %>%
  mutate(fips_code = "1",
         county = "US totals",
         state = "US totals") %>%
  select(fips_code, county, state, cases,deaths) %>%
  inner_join(population_us, by=c("fips_code"))

# join us and counties of interest together and calculate rate of 100k
covid_county_of_interest <- covid_county %>%
  inner_join(population_county, by=c("fips_code")) %>%
  inner_join(counties_of_interest, by=c("fips_code")) %>%
  select(fips_code, county, state, cases,deaths, population) %>%
  bind_rows(covid_us) %>%
  mutate(deaths_per_100k = deaths/population*100000,
         cases_per_100k = cases/population*100000) %>%
  select(county, state, deaths_per_100k, cases_per_100k, deaths, cases)


# Get percentage white
county_pct_white <- get_acs(geography = "county", variables = "B02001_002", summary_var = "B01001_001", year = 2018) %>%
  dplyr::select(geoid = GEOID, white_pop = estimate, total_pop = summary_est) %>%
  mutate(fips_code = as.character(geoid)) %>%
  mutate(pop_pct_white = round(white_pop/total_pop*100,2)) %>%
  mutate(majority_flag = case_when(pop_pct_white  >= 50 ~ "majority_white",
                                   TRUE~"majority_nonwhite")) %>%
  dplyr::select(-geoid, -white_pop, -total_pop)

```

